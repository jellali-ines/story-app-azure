name: Deploy Story App to Azure

on:
  push:
    branches: [ main, master ]
    paths:
      - 'services/**'
      - 'frontend/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-storytelling5
  ACR_NAME: acrstory606755
  BACKEND_APP: backend
  CHATBOT_APP: chatbot
  FRONTEND_APP: frontend

jobs:
  # ===========================
  # Job 1: Build & Push Images
  # ===========================
  build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and Push Backend
        run: |
          cd services/user_service
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/backend:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:latest
          echo "‚úÖ Backend image pushed"

      - name: Build and Push Chatbot
        run: |
          cd services/chatbot
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest
          echo "‚úÖ Chatbot image pushed"

      - name: Build and Push Frontend
        run: |
          cd frontend/front_user
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/frontend:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:latest
          echo "‚úÖ Frontend image pushed"

  # ===========================
  # Job 2: Deploy to Azure
  # ===========================
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend
        run: |
          az containerapp update \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}
          echo "‚úÖ Backend deployed"

      - name: Deploy Chatbot
        run: |
          az containerapp update \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }}
          echo "‚úÖ Chatbot deployed"

      - name: Deploy Frontend
        run: |
          az containerapp update \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }}
          echo "‚úÖ Frontend deployed"

      - name: Get Application URLs
        run: |
          FRONTEND_URL=$(az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv)
          BACKEND_URL=$(az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv)
          CHATBOT_URL=$(az containerapp show --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv)
          
          echo "### üéâ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- üåê Frontend: https://$FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- üîó Backend: https://$BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- ü§ñ Chatbot: https://$CHATBOT_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===========================
  # Job 3: Health Check
  # ===========================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check Backend Health
        run: |
          BACKEND_URL=$(az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv)
          
          echo "Testing Backend: https://$BACKEND_URL/health"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$BACKEND_URL/health)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Backend health check passed"
          else
            echo "‚ö†Ô∏è Backend health check returned $HTTP_CODE"
            exit 1
          fi

      - name: Check Chatbot Health
        run: |
          CHATBOT_URL=$(az containerapp show --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv)
          
          echo "Testing Chatbot: https://$CHATBOT_URL/api/health"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$CHATBOT_URL/api/health)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Chatbot health check passed"
          else
            echo "‚ö†Ô∏è Chatbot health check returned $HTTP_CODE"
            exit 1
          fi

      - name: Check Frontend Accessibility
        run: |
          FRONTEND_URL=$(az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv)
          
          echo "Testing Frontend: https://$FRONTEND_URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$FRONTEND_URL)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Frontend accessibility check passed"
          else
            echo "‚ö†Ô∏è Frontend returned $HTTP_CODE"
            exit 1
          fi