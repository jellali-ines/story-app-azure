name: Deploy Story App to Azure

on:
  push:
    branches: [ main ]
    paths:
      - 'services/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-storytelling5
  ACR_NAME: acrstory606755
  LOCATION: italynorth
  ENV_NAME: env-storytelling
  BACKEND_APP: backend
  CHATBOT_APP: chatbot
  FRONTEND_APP: frontend

jobs:
  # ===========================
  # JOB 1: Build & Push Images
  # ===========================
  build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Backend
        run: |
          cd services/user_service
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/backend
          docker build -t ${IMAGE}:${{ github.sha }} .
          docker tag ${IMAGE}:${{ github.sha }} ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          docker push ${IMAGE}:latest
          echo "‚úÖ Backend image pushed"

      - name: Build and Push Chatbot
        run: |
          cd services/chatbot
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/chatbot
          docker build -t ${IMAGE}:${{ github.sha }} .
          docker tag ${IMAGE}:${{ github.sha }} ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          docker push ${IMAGE}:latest
          echo "‚úÖ Chatbot image pushed"

      - name: Build and Push Frontend
        run: |
          cd frontend/front_user
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/frontend
          docker build --target production -t ${IMAGE}:${{ github.sha }} .
          docker tag ${IMAGE}:${{ github.sha }} ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          docker push ${IMAGE}:latest
          echo "‚úÖ Frontend image pushed"

  # ===========================
  # JOB 2: Deploy to Azure
  # ===========================
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend
        run: |
          MONGODB_URI=${{ secrets.MONGODB_ATLAS_URI }}
          APPINSIGHTS_CONN=$(az monitor app-insights component show --app appinsights-story --resource-group ${{ env.RESOURCE_GROUP }} --query connectionString --output tsv | tr -d '\r')
          
          if ! az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating Backend..."
            az containerapp create \
              --name ${{ env.BACKEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/backend:latest \
              --target-port 5000 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars NODE_ENV=production PORT=5000 "MONGO_URI=${MONGODB_URI}" "MONGODB_ATLAS_URI=${MONGODB_URI}" "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}" \
              --min-replicas 1 --max-replicas 3 --cpu 0.5 --memory 1Gi
          else
            echo "Updating Backend..."
            az containerapp update --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --image ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} --set-env-vars NODE_ENV=production PORT=5000 "MONGO_URI=${MONGODB_URI}" "MONGODB_ATLAS_URI=${MONGODB_URI}" "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}"
          fi

      - name: Deploy Chatbot
        run: |
          APPINSIGHTS_CONN=$(az monitor app-insights component show --app appinsights-story --resource-group ${{ env.RESOURCE_GROUP }} --query connectionString --output tsv | tr -d '\r')
          if ! az containerapp show --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating Chatbot..."
            az containerapp create \
              --name ${{ env.CHATBOT_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest \
              --target-port 5002 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars FLASK_ENV=production OLLAMA_URL=http://${{ secrets.OLLAMA_VM_IP }}:11434/api/generate MODEL_NAME=mistral:latest MAX_REQUESTS_PER_MINUTE=10 MAX_REQUESTS_PER_DAY=1000 "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}" \
              --min-replicas 1 --max-replicas 3 --cpu 0.5 --memory 1Gi
          else
            echo "Updating Chatbot..."
            az containerapp update --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }} --set-env-vars FLASK_ENV=production OLLAMA_URL=http://${{ secrets.OLLAMA_VM_IP }}:11434/api/generate MODEL_NAME=mistral:latest MAX_REQUESTS_PER_MINUTE=10 MAX_REQUESTS_PER_DAY=1000 "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}"
          fi

      - name: Deploy Frontend
        run: |
          BACKEND_URL=$(az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv | tr -d '\r')
          CHATBOT_URL=$(az containerapp show --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv | tr -d '\r')
          if ! az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating Frontend..."
            az containerapp create \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/frontend:latest \
              --target-port 80 --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars VITE_API_URL=https://${BACKEND_URL} VITE_AI_API_URL=https://${CHATBOT_URL} \
              --min-replicas 1 --max-replicas 5 --cpu 0.25 --memory 0.5Gi
          else
            echo "Updating Frontend..."
            az containerapp update --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --image ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }} --set-env-vars VITE_API_URL=https://${BACKEND_URL} VITE_AI_API_URL=https://${CHATBOT_URL}
          fi

  # ===========================
  # JOB 3: Verify Deployment
  # ===========================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Application URLs
        id: urls
        run: |
          BACKEND_URL=$(az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv | tr -d '\r')
          CHATBOT_URL=$(az containerapp show --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv | tr -d '\r')
          FRONTEND_URL=$(az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn --output tsv | tr -d '\r')
          echo "BACKEND_URL=https://$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "CHATBOT_URL=https://$CHATBOT_URL" >> $GITHUB_OUTPUT
          echo "FRONTEND_URL=https://$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Wait for services to be ready
        run: |
          echo "‚è≥ Waiting for services to stabilize..."
          sleep 30

      - name: Test Backend Health
        run: |
          BACKEND_URL="${{ steps.urls.outputs.BACKEND_URL }}"
          echo "Testing: ${BACKEND_URL}/health"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "${BACKEND_URL}/health")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $HTTP_BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Backend health check passed"
          else
            echo "‚ö†Ô∏è Backend health check returned $HTTP_CODE"
          fi

      - name: Test Chatbot Health
        run: |
          CHATBOT_URL="${{ steps.urls.outputs.CHATBOT_URL }}"
          echo "Testing: ${CHATBOT_URL}/api/health"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "${CHATBOT_URL}/api/health")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $HTTP_BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Chatbot health check passed"
          else
            echo "‚ö†Ô∏è Chatbot health check returned $HTTP_CODE"
          fi

      - name: Test Frontend Accessibility
        run: |
          FRONTEND_URL="${{ steps.urls.outputs.FRONTEND_URL }}"
          echo "Testing: ${FRONTEND_URL}"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "${FRONTEND_URL}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Frontend accessibility check passed"
          else
            echo "‚ö†Ô∏è Frontend returned $HTTP_CODE"
          fi

      - name: Test Backend Database Connection
        run: |
          BACKEND_URL="${{ steps.urls.outputs.BACKEND_URL }}"
          echo "Testing: ${BACKEND_URL}/api/test-db"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET "${BACKEND_URL}/api/test-db")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $HTTP_BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Database connection test passed"
          else
            echo "‚ö†Ô∏è Database connection test returned $HTTP_CODE"
            echo "This may be due to MongoDB Atlas network configuration"
          fi

      - name: Final Verification Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT COMPLETED"
          echo "=========================================="
          echo ""
          echo "üåê Frontend:"
          echo "   ${{ steps.urls.outputs.FRONTEND_URL }}"
          echo ""
          echo "üîó Backend:"
          echo "   ${{ steps.urls.outputs.BACKEND_URL }}"
          echo "   Health: ${{ steps.urls.outputs.BACKEND_URL }}/health"
          echo "   Test DB: ${{ steps.urls.outputs.BACKEND_URL }}/api/test-db"
          echo ""
          echo "üîó Chatbot:"
          echo "   ${{ steps.urls.outputs.CHATBOT_URL }}"
          echo "   Health: ${{ steps.urls.outputs.CHATBOT_URL }}/api/health"
          echo ""
          echo "üìä Database: MongoDB Atlas"
          echo "ü¶ô AI Model: mistral:latest"
          echo "‚öôÔ∏è  Framework: Node.js + Flask + React"
          echo ""
          echo "=========================================="