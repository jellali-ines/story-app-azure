name: Deploy Story App to Azure with Monitoring

on:
  push:
    branches: [ main, master ]
    paths:
      - 'services/**'
      - 'frontend/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-storytelling5
  ACR_NAME: acrstory606755
  BACKEND_APP: backend
  CHATBOT_APP: chatbot
  FRONTEND_APP: frontend

jobs:
  # ===========================
  # Job 1: Build & Push Images
  # ===========================
  build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: |
          echo "ğŸ” Logging into Azure Container Registry..."
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and Push Backend
        run: |
          echo "ğŸ—ï¸ Building Backend image..."
          cd services/user_service
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/backend:latest
          
          echo "ğŸ“¤ Pushing Backend image..."
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:latest
          echo "âœ… Backend image pushed successfully"

      - name: Build and Push Chatbot
        run: |
          echo "ğŸ—ï¸ Building Chatbot image..."
          cd services/chatbot
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest
          
          echo "ğŸ“¤ Pushing Chatbot image..."
          docker push ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest
          echo "âœ… Chatbot image pushed successfully"

      - name: Build and Push Frontend
        run: |
          echo "ğŸ—ï¸ Building Frontend image..."
          cd frontend/front_user
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/frontend:latest
          
          echo "ğŸ“¤ Pushing Frontend image..."
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:latest
          echo "âœ… Frontend image pushed successfully"

  # ===========================
  # Job 2: Deploy to Azure
  # ===========================
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend with Monitoring
        run: |
          echo "ğŸš€ Deploying Backend..."
          az containerapp update \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} \
            --set-env-vars \
              MONGODB_URI=secretref:mongodb-uri \
              APPINSIGHTS_CONNECTION_STRING="${{ secrets.APPINSIGHTS_CONNECTION_STRING }}" \
            --output none
          echo "âœ… Backend deployed successfully"

      - name: Deploy Chatbot with Monitoring
        run: |
          echo "ğŸš€ Deploying Chatbot..."
          az containerapp update \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }} \
            --set-env-vars \
              OLLAMA_URL=http://${{ secrets.OLLAMA_VM_IP }}:11434/api/generate \
              APPINSIGHTS_CONNECTION_STRING="${{ secrets.APPINSIGHTS_CONNECTION_STRING }}" \
            --output none
          echo "âœ… Chatbot deployed successfully"

      - name: Deploy Frontend with Monitoring
        run: |
          echo "ğŸš€ Deploying Frontend..."
          az containerapp update \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }} \
            --set-env-vars \
              APPINSIGHTS_CONNECTION_STRING="${{ secrets.APPINSIGHTS_CONNECTION_STRING }}" \
            --output none
          echo "âœ… Frontend deployed successfully"

      - name: Get Application URLs
        run: |
          echo "ğŸ“Š Retrieving application URLs..."
          
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          CHATBOT_URL=$(az containerapp show \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          echo "### ğŸ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Frontend: https://$FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— Backend: https://$BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– Chatbot: https://$CHATBOT_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Commit SHA: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ [Application Insights](https://portal.azure.com/#@/resource/subscriptions/7e61bf81-3416-43bf-84b7-f7a80484e399/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/microsoft.insights/components/appinsights-story/overview)" >> $GITHUB_STEP_SUMMARY

  # ===========================
  # Job 3: Health Check
  # ===========================
  verify:
    name: Verify Deployment & Health
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Wait for Services to Stabilize
        run: |
          echo "â³ Waiting 60 seconds for services to stabilize..."
          sleep 60

      - name: Check Backend Health
        continue-on-error: true
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          echo "ğŸ¥ Testing Backend: https://$BACKEND_URL/health"
          
          # Retry up to 3 times with 10 second delay
          for i in 1 2 3; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://$BACKEND_URL/health || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Backend health check PASSED (HTTP $HTTP_CODE) on attempt $i"
              exit 0
            else
              echo "âš ï¸ Attempt $i: Backend returned HTTP $HTTP_CODE"
              if [ $i -lt 3 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          echo "âš ï¸ Backend health check did not pass after 3 attempts"
          echo "This is not critical - service may need more time to start"

      - name: Check Chatbot Health
        continue-on-error: true
        run: |
          CHATBOT_URL=$(az containerapp show \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          echo "ğŸ¥ Testing Chatbot: https://$CHATBOT_URL/api/health"
          
          # Retry up to 3 times with 10 second delay
          for i in 1 2 3; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://$CHATBOT_URL/api/health || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Chatbot health check PASSED (HTTP $HTTP_CODE) on attempt $i"
              exit 0
            else
              echo "âš ï¸ Attempt $i: Chatbot returned HTTP $HTTP_CODE"
              if [ $i -lt 3 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          echo "âš ï¸ Chatbot health check did not pass after 3 attempts"
          echo "This is not critical - service may need more time to start"

      - name: Check Frontend Accessibility
        run: |
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          echo "ğŸ¥ Testing Frontend: https://$FRONTEND_URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$FRONTEND_URL || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Frontend accessibility check PASSED (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Frontend returned HTTP $HTTP_CODE"
            echo "Note: Service may still be starting up"
          fi

      - name: Health Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ HEALTH CHECK SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "All services have been deployed and tested."
          echo "Check Application Insights for detailed metrics:"
          echo "https://portal.azure.com/#@/resource/subscriptions/7e61bf81-3416-43bf-84b7-f7a80484e399/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/microsoft.insights/components/appinsights-story/overview"
          echo ""
          echo "ğŸ“§ Email alerts configured for: ines.jellali@polytechnicien.tn"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"