name: Deploy Story App to Azure

on:
  push:
    branches: [ main ]
    paths:
      - 'services/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-storytelling5
  ACR_NAME: acrstory606755
  LOCATION: italynorth
  ENV_NAME: env-storytelling
  BACKEND_APP: backend
  CHATBOT_APP: chatbot
  FRONTEND_APP: frontend

jobs:
  # ===========================
  # JOB 1: Build & Push Images
  # ===========================
  build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and Push Backend
        run: |
          echo "üèóÔ∏è Building Backend..."
          cd services/user_service
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/backend
          docker build -t ${IMAGE}:${{ github.sha }} .
          docker tag ${IMAGE}:${{ github.sha }} ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          docker push ${IMAGE}:latest
          echo "‚úÖ Backend image pushed"

      - name: Build and Push Chatbot
        run: |
          echo "üèóÔ∏è Building Chatbot..."
          cd services/chatbot
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/chatbot
          docker build -t ${IMAGE}:${{ github.sha }} .
          docker tag ${IMAGE}:${{ github.sha }} ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          docker push ${IMAGE}:latest
          echo "‚úÖ Chatbot image pushed"

      - name: Build and Push Frontend
        run: |
          echo "üèóÔ∏è Building Frontend..."
          cd frontend/front_user
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/frontend
          
          # Check if production target exists in Dockerfile
          if grep -q "FROM.*AS production" Dockerfile; then
            echo "Building with production target..."
            docker build --target production -t ${IMAGE}:${{ github.sha }} .
          else
            echo "Building without target..."
            docker build -t ${IMAGE}:${{ github.sha }} .
          fi
          
          docker tag ${IMAGE}:${{ github.sha }} ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          docker push ${IMAGE}:latest
          echo "‚úÖ Frontend image pushed"

  # ===========================
  # JOB 2: Deploy to Azure
  # ===========================
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Application Insights Connection String
        id: appinsights
        run: |
          APPINSIGHTS_CONN=$(az monitor app-insights component show \
            --app appinsights-story \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query connectionString \
            --output tsv | tr -d '\r')
          echo "::add-mask::$APPINSIGHTS_CONN"
          echo "APPINSIGHTS_CONN=$APPINSIGHTS_CONN" >> $GITHUB_OUTPUT

      - name: Deploy Backend
        run: |
          echo "üöÄ Deploying Backend..."
          MONGODB_URI="${{ secrets.MONGODB_ATLAS_URI }}"
          APPINSIGHTS_CONN="${{ steps.appinsights.outputs.APPINSIGHTS_CONN }}"
          
          if ! az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating Backend..."
            az containerapp create \
              --name ${{ env.BACKEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/backend:latest \
              --target-port 5000 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars \
                NODE_ENV=production \
                PORT=5000 \
                "MONGO_URI=${MONGODB_URI}" \
                "MONGODB_ATLAS_URI=${MONGODB_URI}" \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}" \
              --min-replicas 1 \
              --max-replicas 3 \
              --cpu 0.5 \
              --memory 1Gi
          else
            echo "Updating Backend..."
            az containerapp update \
              --name ${{ env.BACKEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} \
              --set-env-vars \
                NODE_ENV=production \
                PORT=5000 \
                "MONGO_URI=${MONGODB_URI}" \
                "MONGODB_ATLAS_URI=${MONGODB_URI}" \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}"
          fi
          echo "‚úÖ Backend deployed"

      - name: Deploy Chatbot
        run: |
          echo "üöÄ Deploying Chatbot..."
          APPINSIGHTS_CONN="${{ steps.appinsights.outputs.APPINSIGHTS_CONN }}"
          
          if ! az containerapp show --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating Chatbot..."
            az containerapp create \
              --name ${{ env.CHATBOT_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest \
              --target-port 5002 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars \
                FLASK_ENV=production \
                OLLAMA_URL=http://${{ secrets.OLLAMA_VM_IP }}:11434/api/generate \
                MODEL_NAME=mistral:latest \
                MAX_REQUESTS_PER_MINUTE=10 \
                MAX_REQUESTS_PER_DAY=1000 \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}" \
              --min-replicas 1 \
              --max-replicas 3 \
              --cpu 0.5 \
              --memory 1Gi
          else
            echo "Updating Chatbot..."
            az containerapp update \
              --name ${{ env.CHATBOT_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:${{ github.sha }} \
              --set-env-vars \
                FLASK_ENV=production \
                OLLAMA_URL=http://${{ secrets.OLLAMA_VM_IP }}:11434/api/generate \
                MODEL_NAME=mistral:latest \
                MAX_REQUESTS_PER_MINUTE=10 \
                MAX_REQUESTS_PER_DAY=1000 \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CONN}"
          fi
          echo "‚úÖ Chatbot deployed"

      - name: Deploy Frontend
        run: |
          echo "üöÄ Deploying Frontend..."
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv | tr -d '\r')
          
          CHATBOT_URL=$(az containerapp show \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv | tr -d '\r')
          
          if ! az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating Frontend..."
            az containerapp create \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/frontend:latest \
              --target-port 80 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars \
                VITE_API_URL=https://${BACKEND_URL} \
                VITE_AI_API_URL=https://${CHATBOT_URL} \
              --min-replicas 1 \
              --max-replicas 5 \
              --cpu 0.25 \
              --memory 0.5Gi
          else
            echo "Updating Frontend..."
            az containerapp update \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ github.sha }} \
              --set-env-vars \
                VITE_API_URL=https://${BACKEND_URL} \
                VITE_AI_API_URL=https://${CHATBOT_URL}
          fi
          echo "‚úÖ Frontend deployed"

  # ===========================
  # JOB 3: Verify Deployment
  # ===========================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Application URLs
        id: urls
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv | tr -d '\r')
          
          CHATBOT_URL=$(az containerapp show \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv | tr -d '\r')
          
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv | tr -d '\r')
          
          echo "BACKEND_URL=https://$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "CHATBOT_URL=https://$CHATBOT_URL" >> $GITHUB_OUTPUT
          echo "FRONTEND_URL=https://$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Wait for services to be ready
        run: |
          echo "‚è≥ Waiting 60 seconds for services to stabilize..."
          sleep 60

      - name: Test Backend Health
        continue-on-error: true
        run: |
          BACKEND_URL="${{ steps.urls.outputs.BACKEND_URL }}"
          echo "üè• Testing Backend: ${BACKEND_URL}/health"
          
          for i in 1 2 3; do
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 "${BACKEND_URL}/health" 2>/dev/null || echo -e "\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Backend health check PASSED (HTTP $HTTP_CODE) on attempt $i"
              echo "Response: $HTTP_BODY"
              exit 0
            else
              echo "‚ö†Ô∏è Attempt $i: Backend returned HTTP $HTTP_CODE"
              if [ $i -lt 3 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          echo "‚ö†Ô∏è Backend health check did not pass after 3 attempts"

      - name: Test Chatbot Health
        continue-on-error: true
        run: |
          CHATBOT_URL="${{ steps.urls.outputs.CHATBOT_URL }}"
          echo "üè• Testing Chatbot: ${CHATBOT_URL}/api/health"
          
          for i in 1 2 3; do
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 15 "${CHATBOT_URL}/api/health" 2>/dev/null || echo -e "\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Chatbot health check PASSED (HTTP $HTTP_CODE) on attempt $i"
              echo "Response: $HTTP_BODY"
              exit 0
            else
              echo "‚ö†Ô∏è Attempt $i: Chatbot returned HTTP $HTTP_CODE"
              if [ $i -lt 3 ]; then
                echo "Waiting 15 seconds before retry..."
                sleep 15
              fi
            fi
          done
          echo "‚ö†Ô∏è Chatbot health check did not pass after 3 attempts"

      - name: Test Frontend Accessibility
        continue-on-error: true
        run: |
          FRONTEND_URL="${{ steps.urls.outputs.FRONTEND_URL }}"
          echo "üè• Testing Frontend: ${FRONTEND_URL}"
          
          for i in 1 2 3; do
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 "${FRONTEND_URL}" 2>/dev/null || echo -e "\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Frontend accessibility check PASSED (HTTP $HTTP_CODE) on attempt $i"
              exit 0
            else
              echo "‚ö†Ô∏è Attempt $i: Frontend returned HTTP $HTTP_CODE"
              if [ $i -lt 3 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          echo "‚ö†Ô∏è Frontend check did not pass after 3 attempts"

      - name: Final Verification Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT COMPLETED"
          echo "=========================================="
          echo ""
          echo "üåê Frontend:"
          echo "   ${{ steps.urls.outputs.FRONTEND_URL }}"
          echo ""
          echo "üîó Backend:"
          echo "   ${{ steps.urls.outputs.BACKEND_URL }}"
          echo "   Health: ${{ steps.urls.outputs.BACKEND_URL }}/health"
          echo ""
          echo "ü§ñ Chatbot:"
          echo "   ${{ steps.urls.outputs.CHATBOT_URL }}"
          echo "   Health: ${{ steps.urls.outputs.CHATBOT_URL }}/api/health"
          echo ""
          echo "üìä Monitoring:"
          echo "   https://portal.azure.com/#@/resource/subscriptions/7e61bf81-3416-43bf-84b7-f7a80484e399/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/microsoft.insights/components/appinsights-story/overview"
          echo ""
          echo "üìß Alerts: ines.jellali@polytechnicien.tn"
          echo "üìà Database: MongoDB Atlas"
          echo "ü¶ô AI Model: mistral:latest via Ollama"
          echo "=========================================="