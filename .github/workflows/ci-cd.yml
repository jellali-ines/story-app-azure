name: Deploy Story App to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-storytelling5
  ACR_NAME: acrstory606755
  ENV_NAME: env-storytelling
  BACKEND_APP: backend
  CHATBOT_APP: chatbot
  FRONTEND_APP: frontend

jobs:
  # ===========================
  # JOB 1: Build & Push Images
  # ===========================
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and Push Images
        run: |
          az acr login --name ${{ env.ACR_NAME }}
          
          # Backend
          cd services/user_service
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/backend:latest .
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:latest
          cd ../..
          
          # Chatbot
          cd services/chatbot
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest .
          docker push ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest
          cd ../..
          
          # Frontend
          cd frontend/front_user
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/frontend:latest .
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:latest

  # ===========================
  # JOB 2: Deploy to Azure
  # ===========================
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Application Insights
        id: appinsights
        run: |
          APPINSIGHTS_CONN=$(az monitor app-insights component show \
            --app appinsights-story \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query connectionString --output tsv)
          echo "APPINSIGHTS_CONN=$APPINSIGHTS_CONN" >> $GITHUB_OUTPUT

      - name: Deploy Backend
        run: |
          if az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            az containerapp update \
              --name ${{ env.BACKEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/backend:latest \
              --set-env-vars \
                "MONGO_URI=${{ secrets.MONGODB_ATLAS_URI }}" \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${{ steps.appinsights.outputs.APPINSIGHTS_CONN }}"
          else
            az containerapp create \
              --name ${{ env.BACKEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/backend:latest \
              --target-port 5000 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars \
                "MONGO_URI=${{ secrets.MONGODB_ATLAS_URI }}" \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${{ steps.appinsights.outputs.APPINSIGHTS_CONN }}" \
              --cpu 0.5 --memory 1Gi
          fi

      - name: Deploy Chatbot
        run: |
          if az containerapp show --name ${{ env.CHATBOT_APP }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            az containerapp update \
              --name ${{ env.CHATBOT_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest \
              --set-env-vars \
                "OLLAMA_URL=http://${{ secrets.OLLAMA_VM_IP }}:11434/api/generate" \
                "MODEL_NAME=llama3.1:8b" \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${{ steps.appinsights.outputs.APPINSIGHTS_CONN }}"
          else
            az containerapp create \
              --name ${{ env.CHATBOT_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/chatbot:latest \
              --target-port 5002 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars \
                "OLLAMA_URL=http://${{ secrets.OLLAMA_VM_IP }}:11434/api/generate" \
                "MODEL_NAME=llama3.1:8b" \
                "APPLICATIONINSIGHTS_CONNECTION_STRING=${{ steps.appinsights.outputs.APPINSIGHTS_CONN }}" \
              --cpu 0.5 --memory 1Gi
          fi

      - name: Deploy Frontend
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn --output tsv)
          
          CHATBOT_URL=$(az containerapp show \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn --output tsv)
          
          if az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            az containerapp update \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/frontend:latest \
              --set-env-vars \
                "VITE_API_URL=https://${BACKEND_URL}" \
                "VITE_AI_API_URL=https://${CHATBOT_URL}"
          else
            az containerapp create \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/frontend:latest \
              --target-port 80 \
              --ingress external \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --env-vars \
                "VITE_API_URL=https://${BACKEND_URL}" \
                "VITE_AI_API_URL=https://${CHATBOT_URL}" \
              --cpu 0.25 --memory 0.5Gi
          fi

  # ===========================
  # JOB 3: Verify
  # ===========================
  verify:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get URLs and Test
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn --output tsv)
          
          CHATBOT_URL=$(az containerapp show \
            --name ${{ env.CHATBOT_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn --output tsv)
          
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn --output tsv)
          
          echo "âœ… Deployment Complete!"
          echo "Frontend:  https://$FRONTEND_URL"
          echo "Backend:   https://$BACKEND_URL"
          echo "Chatbot:   https://$CHATBOT_URL"